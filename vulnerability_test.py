# Copyright 2023 Google LLC
#
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE file or at
# https://developers.google.com/open-source/licenses/bsd

"""Tests for the vulnerability module."""

import copy
import re

from vanir import vulnerability
from absl.testing import absltest

_TEST_OSV_ID = 'ASB-A-1234'
_TEST_OSV_MODIFIED = '2024-01-01'
_TEST_ECOSYSTEM = 'Android'
_TEST_PACKAGE_NAME = 'platform/foo'
_TEST_OSV_AFFECTED = {
    'package': {
        'name': _TEST_PACKAGE_NAME,
        'ecosystem': _TEST_ECOSYSTEM,
    }
}
_TEST_OSV_VULN = {
    'id': _TEST_OSV_ID,
    'modified': _TEST_OSV_MODIFIED,
    'affected': [_TEST_OSV_AFFECTED],
}
_TEST_OSV_SIG = {
    'id': 'ASB-A-1234-sigid1',
    'signature_type': 'Function',
    'signature_version': 'v1',
    'source': 'sourceurl',
    'target': {'file': 'targetfile', 'function': 'func'},
    'deprecated': False,
    'digest': {'function_hash': 1234, 'length': 100},
}
_TEST_OSV_SIG2 = {
    'id': 'ASB-A-1234-sigid2',
    'signature_type': 'Function',
    'signature_version': 'v1',
    'source': 'sourceurl',
    'target': {'file': 'targetfile', 'function': 'func'},
    'deprecated': False,
    'digest': {'function_hash': 1234, 'length': 100},
}


class VulnerabilityTest(absltest.TestCase):

  def test_osv_vuln_import(self):
    vuln = vulnerability.Vulnerability(_TEST_OSV_VULN)
    self.assertEqual(vuln.id, _TEST_OSV_ID)
    self.assertEqual(vuln.modified, _TEST_OSV_MODIFIED)
    affected = list(vuln.affected)
    self.assertLen(affected, 1)
    self.assertEqual(affected[0].ecosystem, _TEST_ECOSYSTEM)
    self.assertEqual(affected[0].osv_package_name, _TEST_PACKAGE_NAME)

  def test_setting_affected_packages(self):
    vuln = vulnerability.Vulnerability(_TEST_OSV_VULN)
    vuln.affected = [
        vulnerability.AffectedEntry(
            {'package': {'name': 'test1', 'ecosystem': 'bar'}}
        ),
        vulnerability.AffectedEntry(
            {'package': {'name': 'test2', 'ecosystem': 'baz'}}
        ),
    ]
    self.assertLen(vuln.affected, 2)
    self.assertEqual(vuln.affected[0].osv_package_name, 'test1')
    self.assertEqual(vuln.affected[1].osv_package_name, 'test2')

  def test_osv_vuln_import_with_no_id(self):
    with self.assertRaisesRegex(ValueError, '.*Missing.*'):
      vulnerability.Vulnerability(
          {'modified': _TEST_OSV_MODIFIED, 'affected': [_TEST_OSV_AFFECTED]}
      )
    with self.assertRaisesRegex(ValueError, '.*Missing.*'):
      vulnerability.Vulnerability(
          {
              'id': '',
              'modified': _TEST_OSV_MODIFIED,
              'affected': [_TEST_OSV_AFFECTED]
          }
      )

  def test_osv_vuln_import_with_no_modified(self):
    with self.assertRaisesRegex(ValueError, '.*modified.*'):
      vulnerability.Vulnerability(
          {'id': _TEST_OSV_ID, 'affected': [_TEST_OSV_AFFECTED]}
      )
    with self.assertRaisesRegex(ValueError, '.*modified.*'):
      vulnerability.Vulnerability(
          {
              'id': _TEST_OSV_ID,
              'modified': None,
              'affected': [_TEST_OSV_AFFECTED],
          }
      )

  def test_osv_vuln_import_with_invalid_affected(self):
    with self.assertRaisesRegex(ValueError, '.*affected*'):
      vulnerability.Vulnerability(
          {'id': _TEST_OSV_ID, 'modified': _TEST_OSV_MODIFIED}
      )
    with self.assertRaisesRegex(ValueError, '.*affected.*'):
      vulnerability.Vulnerability(
          {'id': _TEST_OSV_ID, 'modified': _TEST_OSV_MODIFIED, 'affected': []}
      )

  def test_osv_vuln_import_with_invalid_package(self):
    vuln_with_no_package_name = copy.deepcopy(_TEST_OSV_VULN)
    vuln_with_no_package_name['affected'][0]['package'].pop('name')
    with self.assertRaisesRegex(ValueError, '.*package.*'):
      vulnerability.Vulnerability(vuln_with_no_package_name)
    vuln_with_empty_ecosystem = copy.deepcopy(_TEST_OSV_VULN)
    vuln_with_empty_ecosystem['affected'][0]['package']['ecosystem'] = ''
    with self.assertRaisesRegex(ValueError, '.*package.*'):
      vulnerability.Vulnerability(vuln_with_empty_ecosystem)

  def test_to_osv_dict(self):
    vuln = vulnerability.Vulnerability(_TEST_OSV_VULN)
    _TEST_OSV_VULN['affected'][0]['ecosystem_specific'] = {}
    self.assertEqual(vuln.to_osv_dict(), _TEST_OSV_VULN)

  def test_to_osv_dict_after_modification(self):
    vuln = vulnerability.Vulnerability(_TEST_OSV_VULN)
    second_affected = {
        'package': {'name': 'test2', 'ecosystem': 'baz'},
        'ecosystem_specific': {'vanir_signatures': [_TEST_OSV_SIG]},
    }
    vuln.affected.append(vulnerability.AffectedEntry(second_affected))
    vuln.summary = 'test summary'
    vuln.aliases = ['CVE-1234-1234', 'CVE-5678-5678']

    _TEST_OSV_AFFECTED['ecosystem_specific'] = {}
    expected_osv_dict = {
        'id': _TEST_OSV_ID,
        'modified': _TEST_OSV_MODIFIED,
        'summary': 'test summary',
        'aliases': ['CVE-1234-1234', 'CVE-5678-5678'],
        'affected': [_TEST_OSV_AFFECTED, second_affected],
    }
    self.assertEqual(vuln.to_osv_dict(), expected_osv_dict)

  def test_sort_vanir_signatures(self):
    affected = vulnerability.AffectedEntry({
        'package': {'name': 'test2', 'ecosystem': 'baz'},
        'ecosystem_specific': {
            'vanir_signatures': [_TEST_OSV_SIG2, _TEST_OSV_SIG],
        },
    })
    affected.sort_vanir_signatures()
    self.assertEqual(affected.vanir_signatures, [_TEST_OSV_SIG, _TEST_OSV_SIG2])

  def test_meta_package_pattern(self):
    self.assertEqual(
        vulnerability.MetaPackage.ANDROID_KERNEL.package_pattern,
        re.compile(':linux_kernel:.*'),
    )
    self.assertEqual(
        vulnerability.MetaPackage.ANDROID_MODEM.package_pattern,
        re.compile(':modem:.*'),
    )
    self.assertEqual(
        vulnerability.MetaPackage.UNKNOWN.package_pattern,
        re.compile(':unknown:.*'),
    )

  def test_affected_package_normalize_package_name(self):
    affected1 = vulnerability.AffectedEntry({
        'package': {
            'name': 'just/foo/bar/package',
            'ecosystem': _TEST_ECOSYSTEM,
        }
    })
    self.assertEqual(affected1.osv_package_name, 'just/foo/bar/package')
    self.assertEqual(affected1.package_name, 'just/foo/bar/package')

    affected2 = vulnerability.AffectedEntry({
        'package': {
            'name': ':linux_kernel:foo_bar',
            'ecosystem': _TEST_ECOSYSTEM,
        }
    })
    self.assertEqual(affected2.osv_package_name, ':linux_kernel:foo_bar')
    self.assertEqual(affected2.package_name, ':linux_kernel:')

    affected3 = vulnerability.AffectedEntry({
        'package': {
            'name': ':modem:',
            'ecosystem': _TEST_ECOSYSTEM,
        }
    })
    self.assertEqual(affected3.package_name, ':modem:')

  def test_affected_get_versions(self):
    affected1 = vulnerability.AffectedEntry({
        'package': {'name': 'test2', 'ecosystem': 'baz'},
        'versions': ['1.0.0', '1.0.1'],
    })
    self.assertEqual(affected1.versions, ['1.0.0', '1.0.1'])

    affected2 = vulnerability.AffectedEntry({
        'package': {'name': 'test2', 'ecosystem': 'baz'},
    })
    self.assertEqual(affected2.versions, [])


if __name__ == '__main__':
  absltest.main()
